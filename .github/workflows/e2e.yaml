# SPDX-FileCopyrightText: Copyright 2026 Dash0 Inc.
# SPDX-License-Identifier: Apache-2.0

name: Run e2e tests on kind

on:
  # tmp trigger
  push:
    branches:
      - ope-5-e2e-ci
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  DASH0_KIND_CLUSTER: dash0-operator-ci
  DASH0_KIND_CONFIG: /tmp/kind-config.yaml
  LOCAL_REGISTRY_VOLUME_PATH: /tmp/kind-registry
  LOCAL_REGISTRY_NAME: kind-registry
  LOCAL_REGISTRY_PORT: "5001"
  ALLOWED_KUBECTXS: kind-dash0-operator-ci
  E2E_KUBECTX: kind-dash0-operator-ci
  IMAGE_REPOSITORY_PREFIX: "localhost:5001/"

jobs:
  run-e2e-tests-on-kind:
    name: Set up cluster and run e2e tests
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: 8core_32gb
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd

      - name: go version
        run: |
          go version

      - name: kind version
        run: |
          kind version

      - name: kubectl version
        run: |
          kubectl version --client

      - name: Create volume directories and kind config
        run: |
          # Create directories in /tmp for the kind cluster volumes
          mkdir -p /tmp/filelog-offsets
          mkdir -p /tmp/offset-storage
          mkdir -p /tmp/kind-registry

          # Create a temporary kind config with /tmp paths
          cat > /tmp/kind-config.yaml << 'EOF'
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
            - role: control-plane
              extraMounts:
                - hostPath: /tmp/filelog-offsets
                  containerPath: /offset-storage
            - role: worker
              extraPortMappings:
                - containerPort: 80
                  hostPort: 8080
                  protocol: TCP
                - containerPort: 443
                  hostPort: 4443
                  protocol: TCP
              labels:
                nginx-ingress: "true"
              extraMounts:
                - hostPath: /tmp/offset-storage
                  containerPath: /offset-storage
            - role: worker
              extraMounts:
                - hostPath: /tmp/offset-storage
                  containerPath: /offset-storage
          EOF

      - name: Create kind cluster and registry
        run: |
          ./test-resources/bin/create_cluster_and_registry.sh

      - name: Verify cluster is running
        run: |
          echo "Cluster nodes:"
          kubectl get nodes
          echo ""
          echo "Cluster info:"
          kubectl cluster-info
          echo ""
          echo "All pods:"
          kubectl get pods -A

      - name: Verify registry is running
        run: |
          echo "Checking registry container..."
          docker ps --filter name=kind-registry
          echo ""
          echo "Testing registry connectivity..."
          curl -s http://localhost:5001/v2/_catalog || echo "Registry catalog endpoint responded"

      - name: Run e2e tests
        run: |
          make build-all-push-all-test-e2e
