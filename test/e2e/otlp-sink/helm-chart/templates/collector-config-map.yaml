apiVersion: v1
kind: ConfigMap
metadata:
  name: otlp-sink
data:
  config.yaml: |
    extensions:
      health_check:
        endpoint: ${env:K8S_POD_IP}:13100

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: ${env:K8S_POD_IP}:4317
            max_recv_msg_size_mib: 64
          http:
            endpoint: ${env:K8S_POD_IP}:4318
            max_request_body_size: 20971520

    exporters:
    {{- if .Values.discardData }}
      debug/discard:
        verbosity: basic
        sampling_initial: 0
        sampling_thereafter: 0
    {{- else }}
      debug:
        verbosity: detailed
      file/traces:
        path: /telemetry/traces.jsonl
        flush_interval: 100ms
      file/metrics:
        path: /telemetry/metrics.jsonl
        flush_interval: 100ms
      file/logs:
        path: /telemetry/logs.jsonl
        flush_interval: 100ms
    {{- end }}

    service:
      extensions:
        - health_check
      pipelines:
        traces:
          receivers:
            - otlp
          exporters:
            {{- if .Values.discardData }}
            - debug/discard
            {{- else }}
            - debug
            - file/traces
            {{- end }}
        metrics:
          receivers:
            - otlp
          exporters:
            {{- if .Values.discardData }}
            - debug/discard
            {{- else }}
            - debug
            - file/metrics
            {{- end }}
        logs:
          receivers:
            - otlp
          exporters:
            {{- if .Values.discardData }}
            - debug/discard
            {{- else }}
            - debug
            - file/logs
            {{- end }}