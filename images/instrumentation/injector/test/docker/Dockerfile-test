# SPDX-FileCopyrightText: Copyright 2024 Dash0 Inc.
# SPDX-License-Identifier: Apache-2.0

ARG base_image="node:22.15.0-bookworm-slim"
FROM ${base_image}

#  In case you want to add nm and readelf for debugging to the image:
# ARG base_image="node:22.15.0-bookworm-slim"
# RUN case ${base_image} in \
#   *bookworm*) \
#     apt-get update && \
#         apt-get install -y --no-install-recommends \
#           binutils \
#           && \
#         apt-get clean \
#     ;; \
#     \
#   *alpine*) \
#     apk update && \
#     apk upgrade --no-cache && \
#     apk add --no-cache \
#       binutils \
#     ;; \
#     \
#   *) \
#     echo "Base image not supported, stopping build." && \
#     exit 1 \
#     ;; \
#     \
# esac

ARG arch_under_test
RUN if [ -z "$arch_under_test" ]; then \
      echo "Error: build argument arch_under_test is required but not set."; \
      exit 1; \
    fi
ENV ARCH_UNDER_TEST=${arch_under_test}

ARG libc_under_test
RUN if [ -z "libc_under_test" ]; then \
      echo "Error: build argument libc_under_test is required but not set."; \
      exit 1; \
    fi
ENV LIBC_UNDER_TEST=${libc_under_test}

ARG injector_binary
RUN if [ -z "$injector_binary" ]; then \
      echo "Error: build argument injector_binary is required but not set."; \
      exit 1; \
    fi

ARG create_sdk_dummy_files_script
RUN if [ -z "$create_sdk_dummy_files_script" ]; then \
      echo "Error: build argument create_sdk_dummy_files_script is required but not set."; \
      exit 1; \
    fi

WORKDIR /usr/src/dash0/injector/

COPY app app

RUN mkdir compiled-apps

COPY environ-layout/*$arch_under_test.$libc_under_test* compiled-apps/environlayoutapp
COPY statically-built/*$arch_under_test.$libc_under_test* compiled-apps/staticallybuiltapp
RUN ls -la compiled-apps/

COPY scripts/run-tests-within-container.sh scripts/
COPY scripts/create-*.sh scripts/
COPY scripts/*.tests scripts/

RUN echo ${injector_binary}

COPY bin/${injector_binary} /dash0-init-container/injector/dash0_injector.so

RUN ${create_sdk_dummy_files_script}


USER node
CMD ["scripts/run-tests-within-container.sh"]

