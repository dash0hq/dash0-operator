suite: test deployment
templates:
  - operator/deployment-and-webhooks.yaml
tests:
  - it: deployment should match snapshot (default values)
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    asserts:
      - matchSnapshot: {}

  - it: deployment image tags should default to appVersion
    chart:
      version: 4.5.6
      appVersion: 99.100.101
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/dash0hq/operator-controller:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[5].name
          value: DASH0_OPERATOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[5].value
          value: ghcr.io/dash0hq/operator-controller:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[6].name
          value: DASH0_INIT_CONTAINER_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[6].value
          value: ghcr.io/dash0hq/instrumentation:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[7].name
          value: DASH0_COLLECTOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[7].value
          value: ghcr.io/dash0hq/collector:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[9].name
          value: DASH0_CONFIGURATION_RELOADER_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[9].value
          value: ghcr.io/dash0hq/configuration-reloader:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[10].name
          value: DASH0_FILELOG_OFFSET_SYNC_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[10].value
          value: ghcr.io/dash0hq/filelog-offset-sync:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[11].name
          value: DASH0_FILELOG_OFFSET_VOLUME_OWNERSHIP_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[11].value
          value: ghcr.io/dash0hq/filelog-offset-volume-ownership:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[12].name
          value: K8S_POD_UID
      - equal:
          path: spec.template.spec.containers[0].env[12].valueFrom.fieldRef.fieldPath
          value: metadata.uid
      - equal:
          path: spec.template.spec.containers[0].env[13].name
          value: K8S_NODE_IP
      - equal:
          path: spec.template.spec.containers[0].env[13].valueFrom.fieldRef.fieldPath
          value: status.hostIP
      - equal:
          path: spec.template.spec.containers[0].env[14].name
          value: K8S_NODE_NAME
      - equal:
          path: spec.template.spec.containers[0].env[14].valueFrom.fieldRef.fieldPath
          value: spec.nodeName
      - equal:
          path: spec.template.spec.containers[0].env[15].name
          value: K8S_POD_IP
      - equal:
          path: spec.template.spec.containers[0].env[15].valueFrom.fieldRef.fieldPath
          value: status.podIP
      - equal:
          path: spec.template.spec.containers[0].env[16].name
          value: K8S_POD_NAME
      - equal:
          path: spec.template.spec.containers[0].env[16].valueFrom.fieldRef.fieldPath
          value: metadata.name
      - notExists:
          path: spec.template.spec.containers[0].env[17].name

  - it: secret should contain ca and cert
    documentSelector:
      path: metadata.name
      value: dash0-operator-certificates
    asserts:
      - isNotNullOrEmpty:
          path: data["ca.crt"]
      - isNotNullOrEmpty:
          path: data["tls.crt"]
      - isNotNullOrEmpty:
          path: data["tls.key"]

  - it: deployment should match snapshot when using cert-manager
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        certManager:
          useCertManager: true
          secretName: dash0-operator-certificate-secret
          certManagerAnnotations:
            cert-manager.io/inject-ca-from: dash0-system/dash0-operator-serving-certificate
    asserts:
      - matchSnapshot: {}

  - it: should check secretName when using cert-manager
    set:
      operator:
        certManager:
          useCertManager: true
          certManagerAnnotations:
            cert-manager.io/inject-ca-from: dash0-system/dash0-operator-serving-certificate
    asserts:
      - failedTemplate:
          errorMessage: "Error: operator.certManager.useCertManager is set to true, but you did not provide a value for operator.certManager.secretName. Please refer to the instructions at https://github.com/dash0hq/dash0-operator/tree/main/helm-chart/dash0-operator#using-cert-manager."

  - it: should check certManagerAnnotations when using cert-manager
    set:
      operator:
        certManager:
          useCertManager: true
          secretName: dash0-operator-certificate-secret
    asserts:
      - failedTemplate:
          errorMessage: "Error: operator.certManager.useCertManager is set to true, but you did not provide any annotations in operator.certManager.certManagerAnnotations. Please refer to the instructions at https://github.com/dash0hq/dash0-operator/tree/main/helm-chart/dash0-operator#using-cert-manager."

  - it: should render deployment with custom settings
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        replicaCount: 3
        tolerations:
          - key: key1
            operator: Equal
            value: value1
            effect: NoSchedule
          - key: key2
            operator: Exists
            effect: NoSchedule
        webhookService:
          name: custom-webhook-service-name
          port: 554
        additionalLabels:
          label1: "label 1"
          label2: "label 2"
        deploymentAnnotations:
          annotation1: "deployment annotation 1"
          annotation2: "deployment annotation 2"
        podLabels:
          label1: "pod label 1"
          label2: "pod label 2"
        podAnnotations:
          annotation1: "pod annotation 1"
          annotation2: "pod annotation 2"
        image:
          repository: custom-operator-image
          tag: "1.2.3"
          pullPolicy: Never
        initContainerImage:
          repository: custom-init-container-image
          tag: "4.5.6"
          pullPolicy: Always
        imagePullSecrets:
          - name: regcred
          - name: anotherSecret
        collectorImage:
          repository: custom-collector-image
          tag: "7.8.9"
          pullPolicy: Never
        targetAllocatorImage:
          repository: custom-ta-image
          tag: "8.9.10"
          pullPolicy: Never
        configurationReloaderImage:
          repository: custom-configuration-reloader-image
          tag: "10.11.12"
          pullPolicy: Always
        filelogOffsetSyncImage:
          repository: custom-filelog-offset-sync-image
          tag: "13.14.15"
          pullPolicy: Never
        filelogOffsetVolumeOwnershipImage:
          repository: custom-filelog-offset-volume-ownership-image
          tag: "16.17.18"
          pullPolicy: Always
        managerContainerResources:
          limits:
            cpu: 123m
            memory: 456Mi
            ephemeral-storage: 789Mi
          requests:
            cpu: 5m
            memory: 32Mi
            ephemeral-storage: 123Mi
        managerPriorityClassName: operator-manager-priority-class
        developmentMode: true
        pprofPort: 1234

        instrumentation:
          delayAfterEachWorkloadMillis: 13
          delayAfterEachNamespaceMillis: 123
          debug: true
        disableCollectorResourceWatches: true
        collectors:
          debugVerbosityDetailed: true
          sendBatchMaxSize: 32768
          forceUseServiceUrl: true
          disableHostPorts: true
          enablePprofExtension: true
          disableReplicasetInformer: true

    asserts:
      - equal:
          path: metadata.labels['label1']
          value: "label 1"
      - equal:
          path: metadata.labels['label2']
          value: "label 2"
      - equal:
          path: metadata.annotations['annotation1']
          value: "deployment annotation 1"
      - equal:
          path: metadata.annotations['annotation2']
          value: "deployment annotation 2"
      - equal:
          path: spec.replicas
          value: 3
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: key1
              operator: Equal
              value: value1
              effect: NoSchedule
            - key: key2
              operator: Exists
              effect: NoSchedule
      - equal:
          path: spec.template.metadata.labels['label1']
          value: "pod label 1"
      - equal:
          path: spec.template.metadata.labels['label2']
          value: "pod label 2"
      - equal:
          path: spec.template.metadata.annotations['annotation1']
          value: "pod annotation 1"
      - equal:
          path: spec.template.metadata.annotations['annotation2']
          value: "pod annotation 2"
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: regcred
      - equal:
          path: spec.template.spec.imagePullSecrets[1].name
          value: anotherSecret
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom-operator-image:1.2.3
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Never
      - equal:
          path: spec.template.spec.containers[0].args[0]
          value: --health-probe-bind-address=:8081
      - equal:
          path: spec.template.spec.containers[0].args[1]
          value: --metrics-bind-address=127.0.0.1:8080
      - equal:
          path: spec.template.spec.containers[0].args[2]
          value: --leader-elect
      - equal:
          path: spec.template.spec.containers[0].args[3]
          value: --force-use-otel-collector-service-url=true
      - equal:
          path: spec.template.spec.containers[0].args[4]
          value: --gke-autopilot=false
      - equal:
          path: spec.template.spec.containers[0].args[5]
          value: --disable-otel-collector-host-ports=true
      - equal:
          path: spec.template.spec.containers[0].args[6]
          value: --instrumentation-delay-after-each-workload-millis=13
      - equal:
          path: spec.template.spec.containers[0].args[7]
          value: --instrumentation-delay-after-each-namespace-millis=123
      - notExists:
          path: spec.template.spec.containers[0].args[8]
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: DASH0_OPERATOR_NAMESPACE
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: DASH0_DEPLOYMENT_NAME
      - equal:
          path: spec.template.spec.containers[0].env[1].value
          value: dash0-operator-controller
      - equal:
          path: spec.template.spec.containers[0].env[2].name
          value: DASH0_WEBHOOK_SERVICE_NAME
      - equal:
          path: spec.template.spec.containers[0].env[2].value
          value: custom-webhook-service-name
      - equal:
          path: spec.template.spec.containers[0].env[3].name
          value: OTEL_COLLECTOR_NAME_PREFIX
      - equal:
          path: spec.template.spec.containers[0].env[3].value
          value: RELEASE-NAME
      - equal:
          path: spec.template.spec.containers[0].env[4].name
          value: OTEL_TARGET_ALLOCATOR_NAME_PREFIX
      - equal:
          path: spec.template.spec.containers[0].env[4].value
          value: RELEASE-NAME
      - equal:
          path: spec.template.spec.containers[0].env[5].name
          value: DASH0_OPERATOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[5].value
          value: custom-operator-image:1.2.3
      - equal:
          path: spec.template.spec.containers[0].env[6].name
          value: DASH0_INIT_CONTAINER_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[6].value
          value: custom-init-container-image:4.5.6
      - equal:
          path: spec.template.spec.containers[0].env[7].name
          value: DASH0_INIT_CONTAINER_IMAGE_PULL_POLICY
      - equal:
          path: spec.template.spec.containers[0].env[7].value
          value: Always
      - equal:
          path: spec.template.spec.containers[0].env[8].name
          value: DASH0_COLLECTOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[8].value
          value: custom-collector-image:7.8.9
      - equal:
          path: spec.template.spec.containers[0].env[9].name
          value: DASH0_COLLECTOR_IMAGE_PULL_POLICY
      - equal:
          path: spec.template.spec.containers[0].env[9].value
          value: Never
      - equal:
          path: spec.template.spec.containers[0].env[10].name
          value: DASH0_TARGET_ALLOCATOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[10].value
          value: custom-ta-image:8.9.10
      - equal:
          path: spec.template.spec.containers[0].env[11].name
          value: DASH0_TARGET_ALLOCATOR_IMAGE_PULL_POLICY
      - equal:
          path: spec.template.spec.containers[0].env[11].value
          value: Never
      - equal:
          path: spec.template.spec.containers[0].env[12].name
          value: DASH0_CONFIGURATION_RELOADER_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[12].value
          value: custom-configuration-reloader-image:10.11.12
      - equal:
          path: spec.template.spec.containers[0].env[13].name
          value: DASH0_CONFIGURATION_RELOADER_IMAGE_PULL_POLICY
      - equal:
          path: spec.template.spec.containers[0].env[13].value
          value: Always
      - equal:
          path: spec.template.spec.containers[0].env[14].name
          value: DASH0_FILELOG_OFFSET_SYNC_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[14].value
          value: custom-filelog-offset-sync-image:13.14.15
      - equal:
          path: spec.template.spec.containers[0].env[15].name
          value: DASH0_FILELOG_OFFSET_SYNC_IMAGE_PULL_POLICY
      - equal:
          path: spec.template.spec.containers[0].env[15].value
          value: Never
      - equal:
          path: spec.template.spec.containers[0].env[16].name
          value: DASH0_FILELOG_OFFSET_VOLUME_OWNERSHIP_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[16].value
          value: custom-filelog-offset-volume-ownership-image:16.17.18
      - equal:
          path: spec.template.spec.containers[0].env[17].name
          value: DASH0_FILELOG_OFFSET_VOLUME_OWNERSHIP_IMAGE_PULL_POLICY
      - equal:
          path: spec.template.spec.containers[0].env[17].value
          value: Always
      - equal:
          path: spec.template.spec.containers[0].env[18].name
          value: DASH0_DEVELOPMENT_MODE
      - equal:
          path: spec.template.spec.containers[0].env[18].value
          value: "true"
      - equal:
          path: spec.template.spec.containers[0].env[19].name
          value: DASH0_PPROF_PORT
      - equal:
          path: spec.template.spec.containers[0].env[19].value
          value: "1234"
      - equal:
          path: spec.template.spec.containers[0].env[20].name
          value: DASH0_INSTRUMENTATION_DEBUG
      - equal:
          path: spec.template.spec.containers[0].env[20].value
          value: "true"
      - equal:
          path: spec.template.spec.containers[0].env[21].name
          value: DASH0_DISABLE_COLLECTOR_RESOURCE_WATCHES
      - equal:
          path: spec.template.spec.containers[0].env[21].value
          value: "true"
      - equal:
          path: spec.template.spec.containers[0].env[22].name
          value: OTEL_COLLECTOR_DEBUG_VERBOSITY_DETAILED
      - equal:
          path: spec.template.spec.containers[0].env[22].value
          value: "true"
      - equal:
          path: spec.template.spec.containers[0].env[23].name
          value: OTEL_COLLECTOR_SEND_BATCH_MAX_SIZE
      - equal:
          path: spec.template.spec.containers[0].env[23].value
          value: "32768"
      - equal:
          path: spec.template.spec.containers[0].env[24].name
          value: OTEL_COLLECTOR_K8SATTRIBUTES_DISABLE_REPLICASET_INFORMER
      - equal:
          path: spec.template.spec.containers[0].env[24].value
          value: "true"
      - equal:
          path: spec.template.spec.containers[0].env[25].name
          value: OTEL_COLLECTOR_ENABLE_PPROF_EXTENSION
      - equal:
          path: spec.template.spec.containers[0].env[25].value
          value: "true"
      - equal:
          path: spec.template.spec.containers[0].env[26].name
          value: K8S_POD_UID
      - equal:
          path: spec.template.spec.containers[0].env[26].valueFrom.fieldRef.fieldPath
          value: metadata.uid
      - equal:
          path: spec.template.spec.containers[0].env[27].name
          value: K8S_NODE_IP
      - equal:
          path: spec.template.spec.containers[0].env[27].valueFrom.fieldRef.fieldPath
          value: status.hostIP
      - equal:
          path: spec.template.spec.containers[0].env[28].name
          value: K8S_NODE_NAME
      - equal:
          path: spec.template.spec.containers[0].env[28].valueFrom.fieldRef.fieldPath
          value: spec.nodeName
      - equal:
          path: spec.template.spec.containers[0].env[29].name
          value: K8S_POD_IP
      - equal:
          path: spec.template.spec.containers[0].env[29].valueFrom.fieldRef.fieldPath
          value: status.podIP
      - equal:
          path: spec.template.spec.containers[0].env[30].name
          value: K8S_POD_NAME
      - equal:
          path: spec.template.spec.containers[0].env[30].valueFrom.fieldRef.fieldPath
          value: metadata.name
      - notExists:
          path: spec.template.spec.containers[0].env[31].name
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 123m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 456Mi
      - equal:
          path: spec.template.spec.containers[0].resources.limits['ephemeral-storage']
          value: 789Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 5m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 32Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests['ephemeral-storage']
          value: 123Mi
      - equal:
          path: spec.template.spec.priorityClassName
          value: operator-manager-priority-class

  - it: should render instrumentation args from legacy paths
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        instrumentationDelayAfterEachWorkloadMillis: 2
        instrumentationDelayAfterEachNamespaceMillis: 135
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args[6]
          value: --instrumentation-delay-after-each-workload-millis=2
      - equal:
          path: spec.template.spec.containers[0].args[7]
          value: --instrumentation-delay-after-each-namespace-millis=135
      - notExists:
          path: spec.template.spec.containers[0].args[8]

  - it: should add args for creating an operator configuration resource with a token to the deployment
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        dash0Export:
          enabled: true
          endpoint: https://ingress.dash0.com
          token: "very-secret-dash0-auth-token"
          apiEndpoint: https://api.dash0.com
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args[3]
          value: --operator-configuration-endpoint=https://ingress.dash0.com
      - equal:
          path: spec.template.spec.containers[0].args[4]
          value: --operator-configuration-token=very-secret-dash0-auth-token
      - equal:
          path: spec.template.spec.containers[0].args[5]
          value: --operator-configuration-api-endpoint=https://api.dash0.com
      - equal:
          path: spec.template.spec.containers[0].args[6]
          value: --operator-configuration-self-monitoring-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[7]
          value: --operator-configuration-kubernetes-infrastructure-metrics-collection-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[8]
          value: --operator-configuration-collect-pod-labels-and-annotations-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[9]
          value: --operator-configuration-prometheus-crd-support-enabled=false

  - it: should add args for creating an operator configuration resource with a custom dataset to the deployment
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        dash0Export:
          enabled: true
          endpoint: https://ingress.dash0.com
          token: "very-secret-dash0-auth-token"
          apiEndpoint: https://api.dash0.com
          dataset: "test-dataset"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args[3]
          value: --operator-configuration-endpoint=https://ingress.dash0.com
      - equal:
          path: spec.template.spec.containers[0].args[4]
          value: --operator-configuration-token=very-secret-dash0-auth-token
      - equal:
          path: spec.template.spec.containers[0].args[5]
          value: --operator-configuration-api-endpoint=https://api.dash0.com
      - equal:
          path: spec.template.spec.containers[0].args[6]
          value: --operator-configuration-self-monitoring-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[7]
          value: --operator-configuration-kubernetes-infrastructure-metrics-collection-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[8]
          value: --operator-configuration-collect-pod-labels-and-annotations-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[9]
          value: --operator-configuration-prometheus-crd-support-enabled=false
      - equal:
          path: spec.template.spec.containers[0].args[10]
          value: --operator-configuration-dataset=test-dataset

  - it: should add args for creating an operator configuration resource with a cluster name to the deployment
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        dash0Export:
          enabled: true
          endpoint: https://ingress.dash0.com
          token: "very-secret-dash0-auth-token"
          apiEndpoint: https://api.dash0.com
        clusterName: "cluster-name"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args[3]
          value: --operator-configuration-endpoint=https://ingress.dash0.com
      - equal:
          path: spec.template.spec.containers[0].args[4]
          value: --operator-configuration-token=very-secret-dash0-auth-token
      - equal:
          path: spec.template.spec.containers[0].args[5]
          value: --operator-configuration-api-endpoint=https://api.dash0.com
      - equal:
          path: spec.template.spec.containers[0].args[6]
          value: --operator-configuration-self-monitoring-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[7]
          value: --operator-configuration-kubernetes-infrastructure-metrics-collection-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[8]
          value: --operator-configuration-collect-pod-labels-and-annotations-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[9]
          value: --operator-configuration-prometheus-crd-support-enabled=false
      - equal:
          path: spec.template.spec.containers[0].args[10]
          value: --operator-configuration-cluster-name=cluster-name

  - it: should add args for creating an operator configuration resource with a secretRef to the deployment
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        dash0Export:
          enabled: true
          endpoint: https://ingress.dash0.com
          secretRef:
            name: secret-name
            key: secret-key
          # Disabling secret validation is necessary in Helm unit tests since there is no live cluster to check against.
          disableSecretValidation: true
          apiEndpoint: https://api.dash0.com
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args[3]
          value: --operator-configuration-endpoint=https://ingress.dash0.com
      - equal:
          path: spec.template.spec.containers[0].args[4]
          value: --operator-configuration-secret-ref-name=secret-name
      - equal:
          path: spec.template.spec.containers[0].args[5]
          value: --operator-configuration-secret-ref-key=secret-key
      - equal:
          path: spec.template.spec.containers[0].args[6]
          value: --operator-configuration-api-endpoint=https://api.dash0.com
      - equal:
          path: spec.template.spec.containers[0].args[7]
          value: --operator-configuration-self-monitoring-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[8]
          value: --operator-configuration-kubernetes-infrastructure-metrics-collection-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[9]
          value: --operator-configuration-collect-pod-labels-and-annotations-enabled=true
      - equal:
          path: spec.template.spec.containers[0].args[10]
          value: --operator-configuration-prometheus-crd-support-enabled=false

  - it: should disable self-monitoring & Kubernetes infrastructure metrics collection
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        dash0Export:
          enabled: true
          endpoint: https://ingress.dash0.com
          token: "very-secret-dash0-auth-token"
          apiEndpoint: https://api.dash0.com
        selfMonitoringEnabled: false
        kubernetesInfrastructureMetricsCollectionEnabled: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args[3]
          value: --operator-configuration-endpoint=https://ingress.dash0.com
      - equal:
          path: spec.template.spec.containers[0].args[4]
          value: --operator-configuration-token=very-secret-dash0-auth-token
      - equal:
          path: spec.template.spec.containers[0].args[5]
          value: --operator-configuration-api-endpoint=https://api.dash0.com
      - equal:
          path: spec.template.spec.containers[0].args[6]
          value: --operator-configuration-self-monitoring-enabled=false
      - equal:
          path: spec.template.spec.containers[0].args[7]
          value: --operator-configuration-kubernetes-infrastructure-metrics-collection-enabled=false

  - it: should disable pod label and annotation collection
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        dash0Export:
          enabled: true
          endpoint: https://ingress.dash0.com
          token: "very-secret-dash0-auth-token"
          apiEndpoint: https://api.dash0.com
        selfMonitoringEnabled: false
        collectPodLabelsAndAnnotationsEnabled: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args[8]
          value: --operator-configuration-collect-pod-labels-and-annotations-enabled=false

  - it: should enable support for prometheus crds
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        dash0Export:
          enabled: true
          endpoint: https://ingress.dash0.com
          token: "very-secret-dash0-auth-token"
          apiEndpoint: https://api.dash0.com
        selfMonitoringEnabled: false
        prometheusCrdSupportEnabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args[9]
          value: --operator-configuration-prometheus-crd-support-enabled=true

  - it: should render the "dash0.com/cert-digest" label
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    asserts:
      - isNotNullOrEmpty:
          path: spec.template.metadata.labels["dash0.com/cert-digest"]

  - it: should not render the "dash0.com/cert-digest" label if cert-manager is used
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        certManager:
          useCertManager: true
          secretName: dash0-operator-certificate-secret
          certManagerAnnotations:
            cert-manager.io/inject-ca-from: dash0-system/dash0-operator-serving-certificate
    asserts:
      - exists:
          path: spec.template.metadata.labels["dash0.com/cert-digest"]
        not: true

  - it: deployment should support referencing images by digest instead of tag
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        image:
          digest: sha256:e05496f5bcc3c2caf7d2a2944bfc084872d69dd1e9c365a521719c5bbcf4430c
        initContainerImage:
          digest: sha256:1e8c25853217c7393dbd95e17fe2117bb31b39478bbea4479cc5e7c1257dda01
        collectorImage:
          digest: sha256:3e8c25853217c7393dbd95e17fe2117bb31b39478bbea4479cc5e7c1257dda03
        targetAllocatorImage:
          digest: sha256:f3ec1cd500980f4fe5491a102b4a73a9eb3c5bd21bd3ef986c74f97de35a35dc
        configurationReloaderImage:
          digest: sha256:4e8c25853217c7393dbd95e17fe2117bb31b39478bbea4479cc5e7c1257dda04
        filelogOffsetSyncImage:
          digest: sha256:5e8c25853217c7393dbd95e17fe2117bb31b39478bbea4479cc5e7c1257dda05
        filelogOffsetVolumeOwnershipImage:
          digest: sha256:6e8c25853217c7393dbd95e17fe2117bb31b39478bbea4479cc5e7c1257dda06
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/dash0hq/operator-controller@sha256:e05496f5bcc3c2caf7d2a2944bfc084872d69dd1e9c365a521719c5bbcf4430c
      - notExists:
          path: spec.template.spec.containers[0].imagePullPolicy
      - equal:
          path: spec.template.spec.containers[0].env[5].name
          value: DASH0_OPERATOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[5].value
          value: ghcr.io/dash0hq/operator-controller@sha256:e05496f5bcc3c2caf7d2a2944bfc084872d69dd1e9c365a521719c5bbcf4430c
      - equal:
          path: spec.template.spec.containers[0].env[6].name
          value: DASH0_INIT_CONTAINER_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[6].value
          value: ghcr.io/dash0hq/instrumentation@sha256:1e8c25853217c7393dbd95e17fe2117bb31b39478bbea4479cc5e7c1257dda01
      - equal:
          path: spec.template.spec.containers[0].env[7].name
          value: DASH0_COLLECTOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[7].value
          value: ghcr.io/dash0hq/collector@sha256:3e8c25853217c7393dbd95e17fe2117bb31b39478bbea4479cc5e7c1257dda03
      - equal:
          path: spec.template.spec.containers[0].env[8].name
          value: DASH0_TARGET_ALLOCATOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[8].value
          value: ghcr.io/open-telemetry/opentelemetry-operator/target-allocator@sha256:f3ec1cd500980f4fe5491a102b4a73a9eb3c5bd21bd3ef986c74f97de35a35dc
      - equal:
          path: spec.template.spec.containers[0].env[9].name
          value: DASH0_CONFIGURATION_RELOADER_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[9].value
          value: ghcr.io/dash0hq/configuration-reloader@sha256:4e8c25853217c7393dbd95e17fe2117bb31b39478bbea4479cc5e7c1257dda04
      - equal:
          path: spec.template.spec.containers[0].env[10].name
          value: DASH0_FILELOG_OFFSET_SYNC_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[10].value
          value: ghcr.io/dash0hq/filelog-offset-sync@sha256:5e8c25853217c7393dbd95e17fe2117bb31b39478bbea4479cc5e7c1257dda05
      - equal:
          path: spec.template.spec.containers[0].env[11].name
          value: DASH0_FILELOG_OFFSET_VOLUME_OWNERSHIP_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[11].value
          value: ghcr.io/dash0hq/filelog-offset-volume-ownership@sha256:6e8c25853217c7393dbd95e17fe2117bb31b39478bbea4479cc5e7c1257dda06
      - equal:
          path: spec.template.spec.containers[0].env[12].name
          value: K8S_POD_UID
      - equal:
          path: spec.template.spec.containers[0].env[12].valueFrom.fieldRef.fieldPath
          value: metadata.uid
      - equal:
          path: spec.template.spec.containers[0].env[13].name
          value: K8S_NODE_IP
      - equal:
          path: spec.template.spec.containers[0].env[13].valueFrom.fieldRef.fieldPath
          value: status.hostIP
      - equal:
          path: spec.template.spec.containers[0].env[14].name
          value: K8S_NODE_NAME
      - equal:
          path: spec.template.spec.containers[0].env[14].valueFrom.fieldRef.fieldPath
          value: spec.nodeName
      - equal:
          path: spec.template.spec.containers[0].env[15].name
          value: K8S_POD_IP
      - equal:
          path: spec.template.spec.containers[0].env[15].valueFrom.fieldRef.fieldPath
          value: status.podIP
      - equal:
          path: spec.template.spec.containers[0].env[16].name
          value: K8S_POD_NAME
      - equal:
          path: spec.template.spec.containers[0].env[16].valueFrom.fieldRef.fieldPath
          value: metadata.name
      - notExists:
          path: spec.template.spec.containers[0].env[17].name

  - it: deployment should support changing repositories for images
    chart:
      version: 4.5.6
      appVersion: 99.100.101
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    set:
      operator:
        image:
          repository: customrepo.io/repo/custom-operator-controller
        initContainerImage:
          repository: customrepo.io/repo/custom-instrumentation
        collectorImage:
          repository: customrepo.io/repo/custom-collector
        targetAllocatorImage:
          repository: customrepo.io/repo/custom-target-allocator
          tag: "latest"
        configurationReloaderImage:
          repository: customrepo.io/repo/custom-configuration-reloader
        filelogOffsetSyncImage:
          repository: customrepo.io/repo/custom-filelog-offset-sync
        filelogOffsetVolumeOwnershipImage:
          repository: customrepo.io/repo/custom-filelog-offset-volume-ownership
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: customrepo.io/repo/custom-operator-controller:99.100.101
      - notExists:
          path: spec.template.spec.containers[0].imagePullPolicy
      - equal:
          path: spec.template.spec.containers[0].env[5].name
          value: DASH0_OPERATOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[5].value
          value: customrepo.io/repo/custom-operator-controller:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[6].name
          value: DASH0_INIT_CONTAINER_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[6].value
          value: customrepo.io/repo/custom-instrumentation:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[7].name
          value: DASH0_COLLECTOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[7].value
          value: customrepo.io/repo/custom-collector:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[8].name
          value: DASH0_TARGET_ALLOCATOR_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[8].value
          value: customrepo.io/repo/custom-target-allocator:latest
      - equal:
          path: spec.template.spec.containers[0].env[9].name
          value: DASH0_CONFIGURATION_RELOADER_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[9].value
          value: customrepo.io/repo/custom-configuration-reloader:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[10].name
          value: DASH0_FILELOG_OFFSET_SYNC_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[10].value
          value: customrepo.io/repo/custom-filelog-offset-sync:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[11].name
          value: DASH0_FILELOG_OFFSET_VOLUME_OWNERSHIP_IMAGE
      - equal:
          path: spec.template.spec.containers[0].env[11].value
          value: customrepo.io/repo/custom-filelog-offset-volume-ownership:99.100.101
      - equal:
          path: spec.template.spec.containers[0].env[12].name
          value: K8S_POD_UID
      - equal:
          path: spec.template.spec.containers[0].env[12].valueFrom.fieldRef.fieldPath
          value: metadata.uid
      - equal:
          path: spec.template.spec.containers[0].env[13].name
          value: K8S_NODE_IP
      - equal:
          path: spec.template.spec.containers[0].env[13].valueFrom.fieldRef.fieldPath
          value: status.hostIP
      - equal:
          path: spec.template.spec.containers[0].env[14].name
          value: K8S_NODE_NAME
      - equal:
          path: spec.template.spec.containers[0].env[14].valueFrom.fieldRef.fieldPath
          value: spec.nodeName
      - equal:
          path: spec.template.spec.containers[0].env[15].name
          value: K8S_POD_IP
      - equal:
          path: spec.template.spec.containers[0].env[15].valueFrom.fieldRef.fieldPath
          value: status.podIP
      - equal:
          path: spec.template.spec.containers[0].env[16].name
          value: K8S_POD_NAME
      - equal:
          path: spec.template.spec.containers[0].env[16].valueFrom.fieldRef.fieldPath
          value: metadata.name
      - notExists:
          path: spec.template.spec.containers[0].env[17].name

  - it: mutating webhook should have caBundle set
    documentSelector:
      path: metadata.name
      value: dash0-operator-injector
    asserts:
      - isNotNullOrEmpty:
          path: webhooks[0].clientConfig.caBundle

  - it: mutating webhook should have caBundle set also with custom settings
    documentSelector:
      path: metadata.name
      value: dash0-operator-injector
    set:
      operator:
        webhookPort: 554
    asserts:
      - isNotNullOrEmpty:
          path: webhooks[0].clientConfig.caBundle

  - it: validating webhook for operator configuration resource should have caBundle set
    documentSelector:
      path: metadata.name
      value: dash0-operator-operator-configuration-validator
    asserts:
      - isNotNullOrEmpty:
          path: webhooks[0].clientConfig.caBundle

  - it: validating webhook for operator configuration resource should have caBundle set also with custom settings
    documentSelector:
      path: metadata.name
      value: dash0-operator-operator-configuration-validator
    set:
      operator:
        webhookPort: 554
    asserts:
      - isNotNullOrEmpty:
          path: webhooks[0].clientConfig.caBundle

  - it: validating webhook for monitoring resource should have caBundle set
    documentSelector:
      path: metadata.name
      value: dash0-operator-monitoring-validator
    asserts:
      - isNotNullOrEmpty:
          path: webhooks[0].clientConfig.caBundle

  - it: validating webhook for monitoring resource should have caBundle set also with custom settings
    documentSelector:
      path: metadata.name
      value: dash0-operator-monitoring-validator
    set:
      operator:
        webhookPort: 554
    asserts:
      - isNotNullOrEmpty:
          path: webhooks[0].clientConfig.caBundle

  - it: webhook service should render the "dash0.com/cert-digest" label
    documentSelector:
      path: metadata.name
      value: dash0-operator-webhook-service
    asserts:
      - isNotNullOrEmpty:
          path: spec.selector["dash0.com/cert-digest"]

  - it: webhook service should not render the "dash0.com/cert-digest" label if cert-manager is used
    documentSelector:
      path: metadata.name
      value: dash0-operator-webhook-service
    set:
      operator:
        certManager:
          useCertManager: true
          secretName: dash0-operator-certificate-secret
          certManagerAnnotations:
            cert-manager.io/inject-ca-from: dash0-system/dash0-operator-serving-certificate
    asserts:
      - exists:
          path: spec.template.metadata.labels["dash0.com/cert-digest"]
        not: true

  - it: webhook service should match snapshot (default settings)
    documentSelector:
      path: metadata.name
      value: dash0-operator-webhook-service
    asserts:
      - matchSnapshot: {}

  - it: should render webhook service with custom settings
    documentSelector:
      path: metadata.name
      value: custom-webhook-service-name
    set:
      operator:
        webhookService:
          name: custom-webhook-service-name
          port: 554
    asserts:
      - isNotNullOrEmpty:
          path: spec.selector["dash0.com/cert-digest"]
      - equal:
          path: spec.ports[0].port
          value: 554

  - it: should render webhook service port with legacy setting
    documentSelector:
      path: metadata.name
      value: dash0-operator-webhook-service
    set:
      operator:
        webhookPort: 554
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 554

  - it: metrics service should match snapshot (default settings)
    documentSelector:
      path: metadata.name
      value: dash0-operator-metrics
    asserts:
      - matchSnapshot: {}

  - it: should render metrics service with custom settings
    documentSelector:
      path: metadata.name
      value: dash0-operator-metrics
    set:
      operator:
        metricsPort: 9554
        serviceAnnotations:
          annotation1: "metrics service annotation 1"
          annotation2: "metrics service annotation 2"
    asserts:
      - isNotNullOrEmpty:
          path: spec.selector["dash0.com/cert-digest"]
      - equal:
          path: spec.ports[0].port
          value: 9554
      - equal:
          path: metadata.annotations['annotation1']
          value: "metrics service annotation 1"
      - equal:
          path: metadata.annotations['annotation2']
          value: "metrics service annotation 2"

  - it: monitoring resource CRD should match snapshot
    documentSelector:
      path: metadata.name
      value: dash0monitorings.operator.dash0.com
    asserts:
      - matchSnapshot:
          path:
            spec.versions

  - it: monitoring resource CRD should render the "dash0.com/cert-digest" label for the conversion webhook
    documentSelector:
      path: metadata.name
      value: dash0monitorings.operator.dash0.com
    asserts:
      - isNotNullOrEmpty:
          path: spec.selector["dash0.com/cert-digest"]

  - it: monitoring resource CRD should not render the "dash0.com/cert-digest" label if cert-manager is used
    documentSelector:
      path: metadata.name
      value: dash0monitorings.operator.dash0.com
    set:
      operator:
        certManager:
          useCertManager: true
          secretName: dash0-operator-certificate-secret
          certManagerAnnotations:
            cert-manager.io/inject-ca-from: dash0-system/dash0-operator-serving-certificate
    asserts:
      - exists:
          path: spec.template.metadata.labels["dash0.com/cert-digest"]
        not: true

  - it: should consider the provided imagePullSecrets
    set:
      operator:
        dash0Export:
          enabled: true
          endpoint: https://ingress.dash0.com
          token: "very-secret-dash0-auth-token"
          apiEndpoint: https://api.dash0.com
        imagePullSecrets:
          - name: secret-for-private-reg
    documentSelector:
      path: metadata.name
      value: dash0-operator-controller
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets
          value:
            - name: secret-for-private-reg
