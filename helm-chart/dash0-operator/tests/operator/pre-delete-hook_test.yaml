suite: test pre-delete hook job
templates:
  - operator/pre-delete-hook.yaml
tests:
  - it: pre-delete hook job should match snapshot
    asserts:
      - matchSnapshot: {}

  - it: image tag should default to appVersion
    chart:
      version: 4.5.6
      appVersion: 99.100.101
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/dash0hq/operator-controller:99.100.101

  - it: should render tolerations and priority class
    set:
      operator:
        tolerations:
          - key: key1
            operator: Equal
            value: value1
            effect: NoSchedule
          - key: key2
            operator: Exists
            effect: NoSchedule
        managerPriorityClassName: operator-manager-priority-class
    asserts:
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: key1
              operator: Equal
              value: value1
              effect: NoSchedule
            - key: key2
              operator: Exists
              effect: NoSchedule
      - equal:
          path: spec.template.spec.priorityClassName
          value: operator-manager-priority-class

  - it: should consider the provided imagePullSecrets
    set:
      operator:
        dash0Export:
          enabled: true
          endpoint: https://ingress.dash0.com
          token: "very-secret-dash0-auth-token"
          apiEndpoint: https://api.dash0.com
        imagePullSecrets:
          - name: secret-for-private-reg
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets
          value:
            - name: secret-for-private-reg
